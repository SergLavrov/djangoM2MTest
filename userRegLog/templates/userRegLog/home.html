{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <title>Home page</title>
</head>
<body>


<!-- 1 Вар. Вход в "Modal window" for REGISTRATION через ссылку -->
{#    1.1#}
{#    <a class="nav-link active col" aria-current="page" href="#" data-toggle="modal" data-target="#regModal">Регистрация</a>#}
{#    1.2#}
{#    <a href="#regModal" class="nav-link active col" data-toggle="modal">Регистрация</a>#}

<!-- 2 Вар. Вход в "Modal window" for REGISTRATION через кнопку/button -->
{#  <button type="button" class="btn btn-outline-primary nav-link active col" data-toggle="modal"#}
{#          data-target="#registerModal">#}
{#    Регистрация#}
{#  </button>#}

  <a id="register" data-url="{% url 'register' %}" data-csrf-token="{{ csrf_token }}" class="btn btn-primary">Регистрация</a>

  <!-- Кнопка для открытия модального окна ВХОДА -->
{#  <button type="button" class="btn btn-outline-primary nav-link active col" data-toggle="modal"#}
{#          data-target="#loginModal">#}
{#    Войти#}
{#  </button>#}
{#    <a href="#" data-toggle="modal" data-target="#loginModal">Войти</a>#}
{#    <a id="login" data-url="{% url 'login' %}" data-csrf-token="{{ csrf_token }}" class="btn btn-primary">#}
{#      Войти#}
{#    </a>#}
    <a id="login" data-url="{% url 'login' %}" data-csrf-token="{{ csrf_token }}" class="btn btn-outline-primary">Войти</a>


  <div id="registerModal" class="modal fade" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body">

            <!-- Здесь будет загружаться форма -->
            <form method="post" action="{% url 'register' %}">
              {% csrf_token %}

              {{ form.as_p }}

            </form>

            <script>
                $('#register').click(function (event) {
                    event.preventDefault();
                    let registerUrl = $(this).data('url');
                    let csrfToken = $(this).data('csrf-token');
                    // Загрузка формы в модальное окно
                    $.ajax({
                        url: registerUrl,
                        type: 'GET',
                        success: function (response) {
                            $('#registerModal .modal-body').html(response);
                            $('#registerModal').modal('show');
                            // Обработка отправки формы
                            $('#registerModal form').submit(function (event) {
                                event.preventDefault();
                                let formData = $(this).serialize();
                                $.ajax({
                                    url: registerUrl,
                                    type: 'POST',
                                    data: formData + '&csrfmiddlewaretoken=' + csrfToken,
                                    success: function (response) {
                                        if (response.indexOf('alert-danger') === -1) {
                                            location.reload(); // Успешная регистрация
                                        } else {
                                            $('#registerModal .modal-body').html(response); // Ошибки
                                        }
                                    },
                                    error: function () {
                                        alert('Ошибка при обработке запроса.');
                                    }
                                });
                            });
                        },
                        error: function () {
                            alert('Ошибка при загрузке формы.');
                        }
                    });
                });
            </script>
          </div>


        </div>
      </div>


    </div>


<!-- Само модальное окно через стандартный ВАРИАНТ data-target="#registerModal" -->
{#    <div id="registerModal" class="modal fade" tabindex="-1">#}
{#      <div class="modal-dialog modal-dialog-centered">#}
{#        <div class="modal-content">#}
{#          <div class="modal-body">#}
{#            <!-- Здесь будет загружаться форма -->#}
{#            <form method="post" action="{% url 'register' %}">#}
{#              {% csrf_token %}#}
{##}
{#              {{ form.as_p }}#}
{##}
{#              <button type="submit" class="btn btn-success" id="register"#}
{#                      data-url="{% url 'register' %}" data-csrf-token="{{ csrf_token }}">#}
{#                Зарегистрироваться#}
{#              </button>#}
{#              <a id="register" data-url="{% url 'register' %}" data-csrf-token="{{ csrf_token }}" class="btn btn-primary">#}
{#                Регистрация#}
{#              </a>#}
{#              <script src="{% static 'js/script.js' %}"></script>#}
{#            </form>#}
{#          </div>#}
{#        </div>#}
{#      </div>#}
{#    </div>#}


    <div id="loginModal" class="modal fade" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-body">
{#            <!-- Здесь будет загружаться форма -->#}
            <form method="post" action="{% url 'login' %}">
              {% csrf_token %}
              {{ form.as_p }}
{##}
{#              <div class="modal-body">#}
{#                <div class="form-group">#}
{#                  <label for="username">User name:</label>#}
{#                  <input type="text" class="form-control" id="username" name="username">#}
{#                </div>#}
{#                <div class="form-group">#}
{#                  <label for="password">Password:</label>#}
{#                  <input type="password" step="1" class="form-control" id="password" name="password">#}
{#                </div>#}


            <script>
                $('#login').click(function (event) {
                    event.preventDefault();

                    let loginUrl = $(this).data('url');
                    let csrfToken = $(this).data('csrf-token');

                    function bindFormSubmit() {
                        $('#loginModal form').submit(function (event) {
                            event.preventDefault();

                            let formData = $(this).serialize();

                            $.ajax({
                                url: loginUrl,
                                type: 'POST',
                                data: formData,
                                headers: {
                                    'X-CSRFToken': csrfToken,
                                    'X-Requested-With': 'XMLHttpRequest'
                                },
                                success: function (response) {
                                    if (response.indexOf('alert-danger') === -1) {
                                        location.reload();
                                    } else {
                                        $('#loginModal .modal-body').html(response);
                                        bindFormSubmit();
                                    }
                                },
                                error: function () {
                                    alert('Ошибка при входе в систему.');
                                }
                            });
                        });
                    }

                    $.ajax({
                        url: loginUrl,
                        type: 'GET',
                        success: function (response) {
                            $('#loginModal .modal-body').html(response);
                            $('#loginModal').modal('show');
                            bindFormSubmit();
                        },
                        error: function () {
                            alert('Ошибка при загрузке формы.');
                        }
                    });
                });
            </script>

            <button type="submit" class="btn btn-primary">Войти</button>


{#              <a id="login" data-url="{% url 'login' %}" data-csrf-token="{{ csrf_token }}" class="btn btn-primary">#}
{#                Войти#}
{#              </a>#}

            </form>
          </div>
        </div>
      </div>
    </div>




    <!--Блок контента -->
{#     {% block content %}#}
{#     {% endblock %}#}



<!-- Modal window for REGISTRATION -->
{#    <div class="modal fade" id="registerModal" tabindex="-1" role="dialog" aria-labelledby="regModalLabel" aria-hidden="true">#}
{#        <div class="modal-dialog modal-dialog-centered">#}
{##}
{#          <div class="modal-content">#}
{##}
{#            <div class="modal-header bg-secondary text-white">#}
{#              <h4 class="modal-title" id="regModalLabel">Зарегистрироваться</h4>#}
{#              <button class="btn-close" data-dismiss="modal" aria-label="Закрыть"></button>#}
{#               Значек "Х" в верхнем/правом углу !#}
{#            </div>#}
{##}
{#            <form method="post" action="{% url 'register' %}">#}
{##}
{#              {% csrf_token %}#}
{##}
{#              <div class="modal-body">#}
{#                <div class="form-group mb-2">#}
{##}
{#                  {{ form.as_p }}#}
{##}
{#                    {% for field in form %}#}
{#                      Для "стилизации" ФОРМЫ обернем в class="form-group !!!#}
{#                      <div class="form-group">#}
{#                          <label for="">{{ field.label }}</label>#}
{#                          {{ field }}#}
{##}
{#                          {% if field.errors %}#}
{#                            <p>{{ field.errors }}</p>#}
{#                          {% endif %}#}
{#                      </div>#}
{#                    {% endfor %}#}
{#                </div>#}
{#                <a id="register" data-url="{% url 'register' %}" data-csrf-token="{{ csrf_token }}" class="btn btn-primary">#}
{#                  Регистрация#}
{#                </a>#}
{#                <script src="{% static 'js/script.js' %}"></script>#}
{#              </div>#}
{##}
{#              <div class="modal-footer">#}
{#                <a id="register" data-url="{% url 'register' %}" data-csrf-token="{{ csrf_token }}" class="btn btn-primary">#}
{#                  Регистрация#}
{#                </a>#}
                {#                <button type="submit" class="btn btn-primary">Регистрация</button>#}
{#                <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>#}
{#              </div>#}
{#            </form>#}
{##}
{#          </div>#}
{##}
{#        </div>#}
{#      </div>#}

      {#  НЕ забыть подключить вверху страницы {% load static %} !!!#}
      {# в SETTING -->  STATIC_URL = 'static/'#}
      {## Для подключения статического "ВНЕШНЕГО ФАЙЛА" - script.js#}
      {#STATICFILES_DIRS = (os.path.join(BASE_DIR, 'static'),)#}
{#      <script src="{% static 'js/script.js' %}"></script>#}


<!-- Подключаем библиотеку jQuery -->
{#  <script src="libs/jquery/jquery-3.7.1.js"></script>#}

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
  <!-- jQuery и Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<!-- 2-a script для Модального окна -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js" integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+" crossorigin="anonymous"></script>
</body>
</html>